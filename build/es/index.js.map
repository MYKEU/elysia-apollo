{"version":3,"sources":["../../src/index.ts"],"sourcesContent":["import type { Plugin } from 'kingworld'\n\nimport { readdirSync, existsSync } from 'fs'\nimport { join } from 'path'\n\nfunction* walkSync(dir: string): Generator<string> {\n    const files = readdirSync(dir, { withFileTypes: true })\n    for (const file of files) {\n        if (file.isDirectory()) yield* walkSync(join(dir, file.name))\n        else yield join(dir, file.name)\n    }\n}\n\nconst getFiles = (dir: string) => {\n    const files: string[] = []\n    for (const filePath of walkSync(dir)) files.push(filePath)\n\n    return files\n}\n\nconst staticPlugin: Plugin<{\n    /**\n     * @default \"public\"\n     *\n     * Path to expose as public path\n     */\n    path?: string\n    /**\n     * @default '/public'\n     *\n     * Path prefix to create virtual mount path for the static directory\n     */\n    prefix?: string\n    /**\n     * @default 1024\n     *\n     * If total files exceed this number,\n     * file will be handled via wildcard instead of static route\n     * to reduce memory usage\n     */\n    staticLimit?: number\n    /**\n     * @default false\n     *\n     * If set to true, file will always use static path instead\n     */\n    alwaysStatic?: boolean\n    /**\n     * @default [] `Array<string | RegExp>`\n     *\n     * Array of file to ignore publication.\n     * If one of the patters is matched,\n     * file will not be exposed.\n     */\n    ignorePatterns?: Array<string | RegExp>\n}> = (\n    app,\n    {\n        path = 'public',\n        prefix = '/public',\n        staticLimit = 1024,\n        alwaysStatic = false,\n        ignorePatterns = []\n    } = {\n        path: 'public',\n        prefix: '/public',\n        staticLimit: 1024,\n        alwaysStatic: process.env.NODE_ENV === 'production',\n        ignorePatterns: []\n    }\n) => {\n    const files = getFiles(path)\n\n    const shouldIgnore = (file: string) =>\n        ignorePatterns.find((pattern) => {\n            if (typeof pattern === 'string') return pattern.includes(file)\n            else return pattern.test(file)\n        })\n\n    if (\n        alwaysStatic ||\n        (process.env.NODE_ENV === 'production' && files.length <= staticLimit)\n    )\n        files.forEach((file) => {\n            if (shouldIgnore(file)) return\n\n            app.get(`/${join(prefix, file.replace(`${path}/`, ''))}`, () =>\n                Bun.file(file)\n            )\n        })\n    else\n        app.get<{\n            params: {\n                '*': string\n            }\n        }>(`${prefix}/*`, ({ params }) => {\n            const file = `${path}/${params['*']}`\n\n            if (shouldIgnore(file))\n                return new Response('Not Found', {\n                    status: 404\n                })\n\n            return existsSync(file)\n                ? Bun.file(file)\n                : new Response('Not Found', {\n                      status: 404\n                  })\n        })\n\n    return app\n}\n\nexport default staticPlugin\n"],"names":["readdirSync","existsSync","join","walkSync","dir","files","withFileTypes","file","isDirectory","name","getFiles","filePath","push","staticPlugin","app","path","prefix","staticLimit","alwaysStatic","ignorePatterns","process","env","NODE_ENV","shouldIgnore","find","pattern","includes","test","length","forEach","get","replace","Bun","params","Response","status"],"mappings":"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"}